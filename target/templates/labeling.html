<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>数据：{{title}}</title>
    <script src="http://apps.bdimg.com/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="http://cdn.highcharts.com.cn/highcharts/highcharts.js"></script>
    <script src="https://code.highcharts.com.cn/highcharts/modules/exporting.js"></script>
    <script src="/static/js/labeling.js?time='+new Date().getTime()+'"></script>
    <link href="/static/css/labeling.css?time='+new Date().getTime()+'" rel="stylesheet" type="text/css" />

</head>
<div class="login" id="login" >
    <a href="../index/">主页</a>
    {% include "login_info_base.html" %}
</div>

<div class="main" id="main">
	<div class="display" name="display">
		<div  class="vad" id="vad">
		</div>
		<div class="local_pitch" id="local_pitch" >
		</div>
		<div class="local_target" id="local_target" >
		</div>
		<div class="sampling_data" id="sampling_data" >
			<div class="sampling_fft" id="sampling_fft">
			</div>
			<div class="sampling_medium" id="sampling_medium" >
			</div>
		</div>
		<div class="strings_info" id="strings_info">
		</div>
		<div class="ref_info" id="ref_info" >
			{{possiblePos|safe}}
		</div>
		<div class="tone_info" id="tone_info" >
		</div>
		<div class="fingering" id="fingering" >
		</div>
	</div>

	<div class = "opt" name="opt" >
		<div class="algorithm">
			<div class="algorithm_select" >
					算法计算<input type="text" id="algorithm_select" list="algorithm_list" placeholder="算法名称"　onfocus="this.value=''"　
							    onchange="algorithm_selectFunc(this.value,{{labeling_id|safe}})">
				<datalist id="algorithm_list">
					<option value="comb"></option>
					<option value="combDescan"></option>
				</datalist>
			</div>
			<div class="algorithm_opt" id="algorithm_opt">

			</div>
		</div>
		<div class="reference">
			<div class="reference_select" >
					算法配置<input type="text" id="reference_select" list="reference_list" placeholder="算法名称"　onfocus="this.value=''"　
							    onchange="reference_selectFunc(this.value,{{labeling_id|safe}})">
				<datalist id="reference_list">
					<option value="comb"></option>
					<option value="combDescan"></option>
				</datalist>
			</div>
			<div class="reference_opt" id="reference_opt">

			</div>
		</div>

		<div class="info" id="info">
			<table border="" class="table_info" id="table_info" >
				<thead>
					<tr>
						<th >属性</th>
						<th >数值</th>
					</tr>
				</thead>
				<tr>
					<td>title</td>
					<td>
						<input type="text" id="title" readonly="true" value={{title|safe}} />
					</td>
				</tr>
				<tr>
					<td>frameNum</td>
					<td>
						<input type="text" id="frame_num" readonly="true" value={{frame_num|safe}} />
					</td>
				</tr>
				<tr>
					<td style="font-size:1rem;line-height:1;color:green">current_frame</td>
					<td>
						<input type="text" id="current_frame" readonly="true" value={{current_frame|safe}} style="color:green" />
					</td>
				</tr>
				<tr>
					<td>manual_pos</td>
					<td>
						<input type="number" id="manual_pos"  value={{manual_pos|safe}} placeholder="指定下次标记的位置，否则置为负数"/>
					</td>
				</tr>
				<tr>
					<td>nfft</td>
					<td>
						<input type="text" id="nfft" readonly="true" value={{nfft|safe}} />
					</td>
				</tr>
				<tr>
					<td>extend_rad</td>
					<td>
						<input type="number" id="extend_rad" value={{extend_rad|safe}} placeholder="当前标记视窗半径"/>
					</td>
				</tr>
				<tr>
					<td>tone_extend_rad</td>
					<td>
						<input type="number" id="tone_extend_rad" value={{tone_extend_rad|safe}} placeholder="音符参考半径"/>
					</td>
				</tr>
				<tr>
					<td>vad_thrart_EE</td>
					<td>
						<input type="number" id="vad_thrart_EE" value={{vad_thrart_EE|safe}} placeholder="起始位置判定熵阈值"/>
					</td>
				</tr>
				<tr>
					<td>vad_throp_EE</td>
					<td>
						<input type="number" id="vad_throp_EE" value={{vad_throp_EE|safe}} placeholder="终止位置判定熵阈值"/>
					</td>
				</tr>
				<tr>
					<td>vad_thrart_RMSE</td>
					<td>
						<input type="number" id="vad_thrart_RMSE" value={{vad_thrart_RMSE|safe}} placeholder="起始位置判定能量阈值"/>
					</td>
				</tr>
				<tr>
					<td>create_user_id</td>
					<td>
						<input type="text" readonly="true" id="create_user_id" value={{create_user_id|safe}} />
					</td>
				</tr>
			</table>
		</div>
		<div class="strings_set" id="strings_set">
			<table border="" class="strings_set_table" id="strings_set_table">
				<tr>
					<td>1弦</td><td>2弦</td><td>3弦</td><td>4弦</td><td>5弦</td><td>6弦</td><td>7弦</td><td>do</td>
				</tr>
				<tr>
					<td>
						<input onfocus="if(this.value==this.defaultValue){this.value='';placeholder=this.defaultValue}"
						   onblur="if(this.value==''){this.value=this.defaultValue}"/>
					</td>
					<td>
						<input onfocus="if(this.value==this.defaultValue){this.value='';placeholder=this.defaultValue}"
						   onblur="if(this.value==''){this.value=this.defaultValue}"/>
					</td>
					<td>
						<input onfocus="if(this.value==this.defaultValue){this.value='';placeholder=this.defaultValue}"
						   onblur="if(this.value==''){this.value=this.defaultValue}"/>
					</td>
					<td>
						<input onfocus="if(this.value==this.defaultValue){this.value='';placeholder=this.defaultValue}"
						   onblur="if(this.value==''){this.value=this.defaultValue}"/>
					</td>
					<td>
						<input onfocus="if(this.value==this.defaultValue){this.value='';placeholder=this.defaultValue}"
						   onblur="if(this.value==''){this.value=this.defaultValue}"/>
					</td>
					<td>
						<input onfocus="if(this.value==this.defaultValue){this.value='';placeholder=this.defaultValue}"
						   onblur="if(this.value==''){this.value=this.defaultValue}"/>
					</td>
					<td>
						<input onfocus="if(this.value==this.defaultValue){this.value='';placeholder=this.defaultValue}"
						   onblur="if(this.value==''){this.value=this.defaultValue}"/>
					</td>
					<td>
						<input onfocus="if(this.value==this.defaultValue){this.value='';placeholder=this.defaultValue}"
						   onblur="if(this.value==''){this.value=this.defaultValue}"/>
					</td>

				</tr>
			</table>
		</div>
		<div class="sub_strings_set" id="sub_strings_set" >
			<input type="button" name="sub_chin_strings"  value="设置strings" onclick="sub_strings('{{title}}')" style="float:right;"/>
		</div>
		<div class="ref_set" id="ref_set">
			音高
			<input type="number" id="primary_pitch" onfocus="if(this.value==this.defaultValue){this.value=''}"
				   onblur="if(this.value==''){this.value=this.defaultValue}"
				   value={{current_tar|safe}} placeholder="待预测音位的音高"/>
			<input type="button" name="sub_primary_pitch" onclick="cal_pitch_pos('{{title}}')" value="音位估算"
				   style="float:right;">
		</div>
		<div class="filter_set" id="filter_set" >
				频率
				<input type="number" id="filter_frq" onfocus="if(this.value==this.defaultValue){this.value=''}"
					   onblur="if(this.value==''){this.value=this.defaultValue}" value={{current_tar|safe}} placeholder="fft过滤频率"/>
				带宽
				<input type="number" id="filter_width" onfocus="if(this.value==this.defaultValue){this.value=''}"
					   onblur="if(this.value==''){this.value=this.defaultValue}" value={{filter_rad|safe}} placeholder="fft过滤宽度设置"/>
				<input type="button" id="sub_filter_opt" style="float:right"
					   onclick="filter_fft({{srcFFT|safe}},'{{title|safe}}',{{current_frame|safe}},{{nfft|safe}},{{fs|safe}})" value="重新过滤">
		</div>
		<div class="play_clips" id="play_clips" >
				start
				<input type="number" id="play_start" onfocus="if(this.value==this.defaultValue){this.value=''}"
					   onblur="if(this.value==''){this.value=this.defaultValue}"  placeholder="起始帧"/>
				end
				<input type="number" id="play_end" onfocus="if(this.value==this.defaultValue){this.value=''}"
					   onblur="if(this.value==''){this.value=this.defaultValue}"  placeholder="终止帧"/>
				fs
				<input type="number" id="play_fs" onfocus="this.value=''"
					   onblur="if(this.value==''){this.value=this.defaultValue}" value={{play_fs|safe}}
					   placeholder="采样率" list="play_fs_list"/>
				<datalist id="play_fs_list">
					<option value="44100"></option>
					<option value="22050"></option>
					<option value="13230"></option>
					<option value="8820"></option>
					<option value="4410"></option>
				</datalist>
				<input type="button" id="sub_play_clips" style="float:right;width:22%"
					   onclick="play_clips('{{title|safe}}',{{nfft|safe}})" value="播放">
		</div>
		<div class="mark_clips" id="mark_clips">
			fs
			<input type="number" id="mark_fs" onfocus="this.value=''"
					   onblur="if(this.value==''){this.value=this.defaultValue}" value=44100
					   placeholder="采样率" list="play_fs_list" style="width:16%">
			anote
			<input type="text" id="mark_anote" placeholder='注释'
					  style="width:48%">
			<input type="button" id="sub_mark_clips" style="float:right;width:22%"
					   onclick="mark_clips('{{title|safe}}',{{nfft|safe}})" value="mark标记">
		</div>
		<div class="add_tone" id="add_tone">
			<div class="add_tone_table_div" id="add_tone_table_div" >
				<table border="" class="add_tone_table" id="add_tone_table">
					<tr>
						<td style="width:16%;">起始帧</td>
						<td style="width:16%;">终止帧</td>
						<td style="width:16%;">频率</td>
						<td style="width:48%;">指法</td>
					</tr>
					<tr>
						<td style="width:16%;">
							<input type="number" style="width:100%;"/>
						</td>
						<td style="width:16%;">
							<input type="number" style="width:100%;"/>
						</td>
						<td style="width:16%;">
							<input type="number" style="width:100%;"/>
						</td>
						<td style="width:48%;">
							<input type="number" style="width:100%;"/>
						</td>
					</tr>
					<tr>
						<td style="width:16%;">
							<input type="number" style="width:100%;"/>
						</td>
						<td style="width:16%;">
							<input type="number" style="width:100%;"/>
						</td>
						<td style="width:16%;">
							<input type="number" style="width:100%;"/>
						</td>
						<td style="width:48%;">
							<input type="number" style="width:100%;"/>
						</td>
					</tr>
				</table>
			</div>
			<div class="add_tone_sub" >
				<input type="button" style="width:100%; height:100%; border-color:red; " value="提交(T)"/>
			</div>
		</div>
		<div class="clips" id="clips" >

		</div>

	</div>
</div>
<script>
    //关于端点检测的字典数组
   	var ee_data={{ee|safe}};//实际数据
   	var ee_base=new Array({{frame_num|safe}});
   	var current_frame = {{current_frame|safe}};
	var extend_rad = {{extend_rad|safe}};
	var frame_end = {{frame_num|safe}};
	var rmse_data={{rmse|safe}};//实际数据
   	var rmse_base=new Array({{frame_num|safe}});
	var counter=0;
	var stopPos={{stopPos|safe}};//终止位置
	var startPos={{startPos|safe}};//起始位置
   	for(var i= Math.max(current_frame-extend_rad,0);i<Math.min(current_frame+extend_rad,frame_end);i++)
   	{
   		rmse_base[i]=rmse_data[counter];
   		counter++;
   	}
	counter=0;
	for(var i= Math.max(current_frame-extend_rad,0);i<Math.min(current_frame+extend_rad,frame_end);i++)
   	{
   		ee_base[i]=ee_data[counter];
   		counter++;
   	}
    var vadChartDictSeries={"spectral_entropy":ee_base,"rmse":rmse_base};
	for(var i=0;i<stopPos.length;++i)
	{
		stopPos[i]+=Math.max(current_frame-extend_rad,0);
		startPos[i]+=Math.max(current_frame-extend_rad,0);
	}
	console.log(stopPos);
    var vadChartDictLine={
		"stopPos":stopPos,
        "startPos":startPos,
	};

	var start_pos = Math.max(0,current_frame-extend_rad);

	start_pos = Math.min(start_pos,frame_end);
	var end_pos = Math.max(0,current_frame+extend_rad);
	end_pos = Math.min(end_pos,frame_end);
    addChart("",vadChartDictSeries,vadChartDictLine, current_frame,"vad",start_pos,end_pos);
</script>
<script>
	//comb及combDescan用户提供的参考标记
	var refChartDictSeries={"combDescan1":{{combDescanPrimary|safe}},"combdeScan2":{{combDescanSecondary|safe}},"comb":{{comb|safe}}};
    var refChartDictLine={
		"stopPos":stopPos,
        "startPos":startPos,
	};
	var current_frame = {{current_frame|safe}};
	var extend_rad = {{extend_rad|safe}};
	var start_pos = Math.max(0,current_frame-extend_rad);
	var frame_end = {{frame_num|safe}};
	start_pos = Math.min(start_pos,frame_end);
	var end_pos = Math.max(0,current_frame+extend_rad);
	end_pos = Math.min(end_pos,frame_end);
    addChart("",refChartDictSeries,refChartDictLine, current_frame,"local_pitch",start_pos,end_pos);
</script>
<script>
	//已标记音高信息
	var targetArr={{target|safe}};
	var targetChartDictSeries={"target1":targetArr[0],"target2":targetArr[1],"target3":targetArr[2]};
    var targetChartDictLine={
		"stopPos":{{stopPos|safe}},
        "startPos":{{startPos|safe}}	
	};
	var current_frame = {{current_frame|safe}};
	var extend_rad = {{extend_rad|safe}};
	var start_pos = Math.max(0,current_frame-extend_rad);
	var frame_end = {{frame_num|safe}};
	start_pos = Math.min(start_pos,frame_end);
	var end_pos = Math.max(0,current_frame+extend_rad);
	end_pos = Math.min(end_pos,frame_end);
    addChart("",targetChartDictSeries,targetChartDictLine, current_frame,"local_target",start_pos,end_pos);
</script>
<script>
	//fft显示
	var srcChartDictSeries={"fft":{{srcFFT|safe}},"filter_fft":{{filter_fft|safe}}};
	var nfft={{nfft|safe}};
	var fs={{fs|safe}};
	srcChartDictLine=[];
    addChart("",srcChartDictSeries,srcChartDictLine,440*nfft/fs,"sampling_fft",0,parseInt(4000*nfft/fs));
</script>
<script>
	//medium梳状投影
	var mediumChartDictSeries={"medium":{{medium|safe}}};
	var fs={{fs|safe}};
	mediumChartDictLine=[];
    addChart("",mediumChartDictSeries,mediumChartDictLine,440*441000/fs,"sampling_medium",0,mediumChartDictSeries["medium"].length);
</script>
<script>
	//播放音乐片段
	var current_frame = {{current_frame|safe}};
	var extend_rad = {{extend_rad|safe}};
	var start_pos = Math.max(0,current_frame-extend_rad);
	var frame_end = {{frame_num|safe}};
	start_pos = Math.min(start_pos,frame_end);
	var end_pos = Math.max(0,current_frame+extend_rad);
	end_pos = Math.min(end_pos,frame_end);
	document.getElementById('play_start').defaultValue=start_pos;
	document.getElementById('play_end').defaultValue=end_pos;
</script>
<script>
	//显示tones
	var tones_local_var={{tones_local|safe}};
	var table_str="<table border='' class='table_tones' id='table_tones' >";
	table_str=table_str+"<tr><td>pos</td>";
	for (tone in tones_local_var)
	{
		table_str=table_str+'<td>'+tones_local_var[tone].fields.pos+'</td>';
	}
	table_str=table_str+"</tr>";
	table_str=table_str+"<tr><td>len</td>";
	for (tone in tones_local_var)
	{
		table_str=table_str+'<td>'+tones_local_var[tone].fields.length+'</td>';
	}
	table_str=table_str+"</tr>";
	table_str=table_str+"<tr><td>tone</td>";
	for (tone in tones_local_var)
	{
		table_str=table_str+'<td>'+tones_local_var[tone].fields.tone+'</td>';
	}
	table_str=table_str+"</tr>";
	table_str=table_str+"</table>"
	document.getElementById('tone_info').innerHTML=table_str;
</script>
<script>
	//显示tones(全部信息，且可编辑)
	var tones_local_var={{tones_local|safe}};
	var table_str="<table border='' class='table_fingering' id='table_fingering' >";
	for (tone in tones_local_var)
	{
		table_str=table_str+'<tr>';
		table_str=table_str+'<td>'+tones_local_var[tone].fields.pos+'</td>';
		table_str=table_str+'<td>'+tones_local_var[tone].fields.length+'</td>';
		table_str=table_str+'<td>'+tones_local_var[tone].fields.pitch+'</td>';
		table_str=table_str+'<td>'+tones_local_var[tone].fields.note+'</td>';
		table_str=table_str+'<td>'+tones_local_var[tone].fields.tone+'</td>';
		table_str=table_str+'<td>'+tones_local_var[tone].fields.anote+'</td>';
		table_str=table_str+'<td><input type="button" value="删除" onclick="deleteTone(tones_local_var[tone])"/></td>';
		table_str=table_str+'<td><input type="button" value="重置"/></td>';
		table_str=table_str+'</tr>';
	}
	table_str=table_str+"</table>"
	document.getElementById('fingering').innerHTML=table_str;
</script>
<script>
	//显示定弦信息
    var string_notes={{string_notes|safe}};
    var divItem=document.getElementById("strings_info");
    var string_do='{{string_do|safe}}';
    var pitch_scaling = {{pitch_scaling|safe}};
    var strings_info_table="<table border='1' class='strings_info_table'　id='strings_info_table'><tr>";
    for (var i=0;i<string_notes.length;++i){
    	strings_info_table+="<td>"+string_notes[i]+"</td>";
    }
    strings_info_table+="<td>do= "+string_do+"</td>";
    strings_info_table+="<td>scaling="+pitch_scaling.toString()+"</td>";
    strings_info_table+="</tr></table>";
    divItem.innerHTML=strings_info_table;
</script>
<script>
	//设置定弦信息
    var string_hzes={{string_hzes|safe}};
    var string_do='{{string_do|safe}}';
    var table_row=document.getElementById("strings_set_table").rows[1];
    for (var i=0;i<string_hzes.length;++i){
    	var item=table_row.cells[i].getElementsByTagName("INPUT")[0];
    	item.defaultValue=string_hzes[i].toFixed(2);
    }
	var divItem=table_row.cells[string_hzes.length].getElementsByTagName("INPUT")[0];
    divItem.defaultValue=string_do;
</script>
<script>
	var clipsLocal={{clipsLocal|safe}};
	var clips_str="<table border='' class='table_clips_local' id='table_clips_local' >";
	for(var i=0;i<clipsLocal.length;i++)
	{
		clips_str+="<tr>";
		clips_str+="<td>"+clipsLocal[i]["startingPos"]+"</td>";
		clips_str+="<td>"+clipsLocal[i]["length"]+"</td>";
		var index=3;
		for (pitch in clipsLocal[i]["tar"])
		{
			clips_str+='<td><input type="number" value="'+clipsLocal[i]["tar"][pitch].toString()+'"</td>'
			index--;
		}
		for(var j=0;j<index;++j)
		{
			clips_str+='<td><input type="number" /></td>';
		}
		clips_str+='<td><input type="button" value="删除" onclick="deleteClip(clipsLocal[i])"/></td>';
		clips_str+='<td><input type="button" value="重置" onclick="resetClip(clipsLocal[i])"/></td>';
		clips_str+="</tr>";
	}
	clips_str+="<tr>";
	clips_str+="<td><input type='number' style='color:blue;font-size:1rem' value='"+
	{{current_frame|safe}}+"' /></td><td><input type='number' style='color:blue;font-size:1rem' value='"
	+{{current_frame|safe}}+"'/>"+
	"</td><td><input type='number' style='color:blue;font-size:1rem' value='-1'/></td>"+
	" <td><input type='number' style='color:blue;font-size:1rem'/></td>"+
	"<td><input type='number' style='color:blue;font-size:1rem'/></td>"+
	"<td><input type='button' style='color:blue;font-size:1rem' value='插入(P)'/></td>"+
	"<td><input type='button' style='color:blue;font-size:1rem' value='移动到'/></td>";
	clips_str+="</tr>";
	clips_str+="</table>";
	var divItem=document.getElementById("clips");
	divItem.innerHTML=clips_str;
</script>
<script>
    // 总是滚动到最低端
    function top_set(divName){
        var clipDiv = document.getElementById(divName);
        clipDiv.scrollTop = clipDiv.scrollHeight;
    }
    top_set("fingering");
    top_set("clips");
</script>

</body>
</html>

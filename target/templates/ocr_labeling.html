<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Data：{{title}}</title>
        <script src="http://apps.bdimg.com/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://www.chinaudio.tech/static/js/ocr_labeling.js"></script>
        <script src="../static/js/gDBox.pkg.min.js"></script>
        <link href="http://www.chinaudio.tech/static/css/ocr_labeling.css" rel="stylesheet" type="text/css" />
        <link rel="icon" href="http://cdn.chinaudio.tech/static/image/favicon.ico" mce_href="http://cdn.chinaudio.tech/static/image/favicon.ico" type="image/x-icon">
    </head>
    <body >
        <div class="login" id="login" >
            <a href="../index/">Home</a>
            {% include "login_info_base.html" %}
        </div>
        <div class="main" id="main" >
            <div class="title" id="title">
                ocr标注数据库:{{title}}
            </div>
            <div class="image_info" id="image_info">
            </div>
            <div class="page_image" id="page_image">
                <div class="page_image_disp" id="page_image_disp">
                </div>
                <div class="page_image_tool" id="page_image_tool">
                    <div class="page_image_tool_a" id="page_image_tool_a">
                        <div class="page_image_tool_select" id="page_image_tool_select" >
                            <label style="font-size:2rem">
                                <input type="radio" name="labeling_mode" value="manual_select" checked="true" onchange="labeling_mode=this.value"/>
                                手动标注
                            </label>
                            <br>
                            <label style="font-size:2rem">
                                <input type="radio" name="labeling_mode" value="recommend_select"  onchange="labeling_mode=this.value"/>
                                标注推荐
                            </label>
                            <br>
                            <label style="font-size:2rem">
                                <input type="radio" name="labeling_mode" value="clear_select"  onchange="labeling_mode=this.value"/>
                                区域删除
                            </label>
                            <br>
                            <label style="font-size:2rem">
                                <input style="font-size:2rem" type="button" id="delete_all_polygon" value="整页删除" onclick="delete_all_polygon({{image_id}})"/>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="select_page" id="select_page">
                <table>
                    <tr>
                        <td>
                            <input type="number" id="input_page_id" min="0" max="{{frame_num|add:-1}}" value="{{frame_id}}"/>
                        </td>
                        <td>
                            <input type="button" id="sub_page_id" value="跳转" onclick="jump_page({{ocr_pdf_id}},{{frame_num}})"/>
                        </td>
                        <td>
                            <input type="button" id="prior_page" value="上一帧" onclick="move2prior({{ocr_pdf_id}},{{frame_id}},{{frame_num}})"/>
                        </td>
                        <td>
                            <input type="button" id="next_page" value="下一帧" onclick="move2next({{ocr_pdf_id}},{{frame_id}},{{frame_num}})"/>

                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <script>
            var labeling_mode="manual_select";
            $(document).ready(function() {
                while(typeof gDBox == "undefined"){
                    
                }
                var div_img=document.getElementById("page_image_disp");
                var div_width = div_img.offsetWidth;
                var div_height = div_img.offsetHeight;
                tar_size = cal_size(div_width,div_height,{{ori_width}},{{ori_height}});
                tar_width = tar_size["width"];
                tar_height = tar_size["height"];
                tar_room = Math.max(tar_width,tar_height);
                // 显示尺度信息
                document.getElementById("image_info").innerHTML="frame_id:"+{{frame_id}}+"&nbsp&nbsp ori_width:"+{{ori_width}}+"&nbsp&nbsp ori_height:"+{{ori_height}}+"&nbsp&nbsp tar_width:"+tar_width+"&nbsp&nbsp tar_height:"+tar_height+"&nbsp&nbsp div_width:"+div_width+"&nbsp&nbsp div_height:"+div_height;
                // 常用样式声明
                const gFetureStyle = new gDBox.Style({strokeColor: '#0000FF', lineWeight: 1});
                // 容器对象声明
                let gMap = new gDBox.Map('page_image_disp', {w:tar_width, zoom: tar_room, cx: 0, cy: 0, zoomMax: tar_width* 10, zoomMin: tar_width / 10});
                // 设置当前操作模式为‘drawRect’
                gMap.setMode('drawRect', gFetureStyle);
                // 图片层实例\添加
                let gImageLayer = new gDBox.Layer.Image('img', "../ocr_labeling/get_image/?frame_id={{image_id}}&tar_width="+tar_width+"&tar_height="+tar_height, {w:tar_width, h: tar_height}, {zIndex: 1});
                gMap.addLayer(gImageLayer);
                // 矢量层实例\添加
                let gFeatureLayer = new gDBox.Layer.Feature('featureLayer', {zIndex: 2, transparent: true});
                gMap.addLayer(gFeatureLayer);
                //显示所有标注框
                var polygon_list = {{polygon_list|safe}};
                for (polygon in polygon_list){
                    var polygon_points=JSON.parse(polygon_list[polygon]['points']);
                    var polygon_id = JSON.parse(polygon_list[polygon]['polygon_id']);
                    polygon_map = img2gdbox_map(polygon_points,tar_width,tar_height,{{ori_width}},{{ori_height}});
                    add_polygon_disp(gFeatureLayer,gFetureStyle, polygon_map, polygon_id);
                }
                gMap.events.on('geometryDrawDone', function (type, points) {
                    switch(labeling_mode){
                        case "manual_select":
                            labeling_points=gdbox2img_map(points, tar_width, tar_height,{{ori_width}},{{ori_height}});
                            image_id = add_labeling_polygon({{image_id}}, labeling_points);
                            add_polygon_disp(gFeatureLayer,gFetureStyle, points, polygon_id);
                            break;
                        case "recommend_select":
                            console.log(labeling_mode);
                            break;
                        case "clear_select":
                            console.log(labeling_mode);
                            break;
                        case "default":
                            alser("labeling_mode err!");
                    }
                });
                gMap.events.on(
                    'geometryEditDone', 
                    function (type, activeFeature, points) {
                        activeFeature.update({points});
                        activeFeature.show();
                    }
                );
                // feature-reset监听
                gMap.events.on(
                    'featureStatusReset',
                    function () {
                        gMap.mLayer.removeAllMarkers();
                    }
                );


            });
        </script>
    </body>
</html>
